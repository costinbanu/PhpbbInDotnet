# A phpBB revamp in .Net

This is a .Net version of the popular phpBB forums platform, targeting MySql. It currently does not offer 100% of all features, but it is fully compatible with the database and can be just "plugged in" to the DB (after running an automated DB update process).

## Prerequisites
This installation requires a MySQL type of server (and it is fully compatible with MariaDB and AuroraDB as well).

This application requires stored procedures, so you must have the proper setup for creating them (for example, MariaDB requires root access for this).

This application uses [Google reCAPTCHA v3](https://www.google.com/recaptcha/about/) for spam protection. Visit their website and set reCAPTCHA up before deploying the application. The setup is as simple as entering the site keys in the configuration.

This application uses AES symmetric encryption for encrypting the password reset codes. The encryption key is generated by concatenating two guids, which must be specified in the configuration. Use this [online guid generator](https://www.guidgenerator.com/) to get your guids.

## Installation
### Set up the configuration
This application requires a custom configuration object. You may use your own app settings provider (`appsettings.json` file, user secrets, Azure app settings store and so on) to set it up, but be aware that by default it only supports `appsettings.json` (so it will require some coding to add your own provider). Either way,  ensure that its structure and contents follow the sample below. All fields are detailed below.

```json
{
  "ForumDbConnectionString": "...",
  "Recaptcha": {
    "SiteKey": "...",
    "SecretKey": "...",
    "BaseAddress": "https://www.google.com",
    "RelativeUri": "recaptcha/api/siteverify",
    "ClientName": "g-recaptcha",
    "MinScore": 0.6
  },
  "Smtp": {
    "Host": "...",
    "Username": "...",
    "Password": "..."
  },
  "Encryption": {
    "Key1": "...",
    "Key2": "..."
  },
  "AvatarSalt": "...",
  "BaseUrl": "...",
  "ForumName": "...",
  "LoginSessionSlidingExpiration": "30.00:00:00", 
  "UploadLimitsMB": {
    "Images": 2,
    "OtherFiles": 20
  },
  "UploadLimitsCount": {
    "Images": 10,
    "OtherFiles": 10
  },
  "UserActivityTrackingInterval": "00.01:00:00", 
  "AdminEmail": "...",
  "Storage": { 
    "Files": "forumfiles",
    "Avatars": "forumfiles/avatars",
    "Emojis": "images/smilies"
  },
  "AvatarMaxSize": {
    "Width": 200,
    "Height": 200
  },
  "EmojiMaxSize": {
    "Width": 100,
    "Height": 100
  }
}
```

Field details:

Field name | Value | Notes
--- | --- | ---
ForumDbConnectionString | ... |  your DB connection string (root access, no implicit database selected)
Recaptcha.SiteKey | ... | site key 
Recaptcha.SecretKey | ... | secret key 
Recaptcha.BaseAddress | https://www.google.com | Base URL for captcha verification 
Recaptcha.RelativeUri | recaptcha/api/siteverify | Relative URL for captcha verification 
Recaptcha.ClientName | g-recaptcha | HttpClientName used in dependency injection 
Recaptcha.MinScore | 0.6 | this value can be changed as per [reCAPTCHA documentation](https://developers.google.com/recaptcha/docs/v3); 0.6 is the value working best for our setup
Smtp.Host | ... | your SSL-enabled SMTP host 
Smtp.Username | ... | SMTP username 
Smtp.Password | ... | SMTP password
Encryption.Key1 | ... | first guid for AES symmetric key generation 
Encryption.Key2 | ... | second guid for AES symmetric key generation 
AvatarSalt | ... | it is a unique way of naming avatar files and is expected to be a lowercase guid without dashes. If this is a new installation, then use the guid generator mentioned above to generate a lowercase guid without dashes. However, if this is an update from phpBB, then get your avatar salt by running this in your forum's DB: `SELECT config_value FROM phpbb_config WHERE config_name = 'avatar_salt'` 
BaseUrl | ... | forum base url
ForumName | ... | forum name 
LoginSessionSlidingExpiration | 30.00:00:00 | inactivity time before user is logged out. Is read as `TimeSpan` (format `dd.HH:mm:ss`), default value is 30 days
UploadLimitsMB.Images | 2 | applies for both internally and externally hosted images
UploadLimitsMB.OtherFiles | 20 | applies only for internally hosted attachments
UploadLimitsCount.Images | 10 |  applies for both internally and externally hosted images
UploadLimitsCount.OtherFiles | 10 | applies only for internally hosted attachments
UserActivityTrackingInterval | 00.01:00:00 | time interval for tracking same user's activity. Is read as `TimeSpan` (format `dd.HH:mm:ss`), default value is 1 hour
AdminEmail | ... | sender email address for forum generated emails 
Storage.Files | forumfiles | path relative to `wwwroot` 
Storage.Avatars | forumfiles/avatars | path relative to `wwwroot` 
Storage.Emojis | images/smilies | path relative to `wwwroot` 
AvatarMaxSize.Width | 200 | pixels
AvatarMaxSize.Height | 200 | pixels
EmojiMaxSize.Width | 100 | pixels
EmojiMaxSize.Height | 100 | pixels

### Install the application

1. Build the solution and deploy it to your host.
2. Execute the `PhpbbInDotnet.Database.SetupApp` application (make sure its `appsettings.json` file contains a valid connection string targeting your MySQL / MariaDB / AuroraDB server with root access)
3. Done!

## Feature and functionality differences
As of now, the platform **does not support the following phpBB features**:
- Bookmarks
- Forum icons
- Post approval
- Private message folders
- Forum and topic watch
- User warnings

The platform also **supports some new features**:
- Personalized pagination (per user and topic)
- Attachment upload quota (per group)
- Personalized edit time of own posts (per group or user, with the latter taking precedence if both defined)

## Further reading
### Technical considerations
This application targets .Net 5.0 and is platform agnostic.

However, it has not yet been researched if the database support can be extended further than the MySQL-compatible languages. Given that the code leverages both stored procedures and inline SQL (through [Dapper](https://github.com/DapperLib/Dapper)), as well as LINQ-to-SQL statements (through [Entity Framework Core](https://docs.microsoft.com/en-us/ef/core/)), it is expected that multiple database support might not be trivial and might take more time to set up.

### phpBB backwards compatibility
- Authentication is backwards compatible with the hashed passwords from an existing database. The [CryptSharp.Core](https://github.com/costinbanu/CryptSharp.Core) library is used to achieve this.
- Text formatting and rendering is backwards-compatible with the original phpBB rendering engine (the new platform can render 100% of bb code written on a phpBB platform, while a phpBB platform can render around 90% of bb code written on this platform). The [CodeKicker.BBCode.Core](https://github.com/costinbanu/CodeKicker.BBCode.Core) library is used for rendering bb code.

### Maintenance and future work
This platform is currently live at https://forum.metrouusor.com/ (which has served as basis for feature implementation, as well as a beta-testing site by running the old phpBB installation and the new platform in parallel for several months). As long as this forum is up, this platform is expected to be maintained regularily.

Although unplanned as of now, future work will include further personalization options (with regards to image rendering), more themes and more languages.