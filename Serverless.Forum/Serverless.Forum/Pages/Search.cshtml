@page
@model Serverless.Forum.Pages.SearchModel
@{
    ViewData["Title"] = "Search";
    Layout = "~/Pages/_Layout.cshtml";
    var dateFormat = (await Model.GetCurrentUserAsync()).UserDateFormat;
    var IsAnonymous = Model.CurrentUserId == 1;
}

<h2>Caută</h2>
<script src="~/lib/jquery/dist/jquery.js"></script>
<script src="~/lib/jquery-ui/jquery-ui.js"></script>
<script type="text/javascript" src="~/js/site.js">
    window.onload = function () { onPostLoad(); }
</script>

<form method="post">
    <input asp-for="QueryString" type="hidden" />
    <input asp-for="PageNumber" type="hidden" />
    <input asp-for="TotalResults" type="hidden" />

    <input asp-for="SearchText" type="text" placeholder="Caută după text..." style="width:100%" />
    <p>&nbsp;</p>
    Caută în forumul...
    <div style="height:400px; max-height:600px; overflow-y:scroll">
        @await Html.PartialAsync(
            "_ForumTreePartial",
             new _ForumTreePartialModel
             {
                 Forums = await Model.GetForumTree(),
                 ForumId = Model.ForumId,
                 TopicId = Model.TopicId,
                 PathToForumOrTopic = await Model.PathToForumOrTopic(Model.ForumId, Model.TopicId)
             },
            ViewData
        )
    </div>
    <input asp-for="ForumId" type="hidden" id="ForumIdInput" />
    <p>&nbsp;</p>
    <select name="TopicId" id="TopicIdDisplay" style="width:100%">
        <option selected disabled value="-1">Caută în subiectul...</option>
        <option value="0">Caută în toate subiectele</option>
    </select>
    <p>&nbsp;</p>
    <input asp-for="AuthorId" type="text" placeholder="Caută după autor..." id="AuthorInput" style="width:100%" />
    <p>&nbsp;</p>
    <input type="submit" value="Trimite" />
</form>

@if (Model.Posts != null && Model.Posts.Any())
{
    <h2>Rezultate</h2>
    <table style="border:none;">
        <tr>
            @if (!Model.IsFirstPage)
            {
                <td style="padding-right:10px; border-right: solid 1px black">
                    <a href="@Model.GetSearchLinkForPage(Model.PageNumber.Value - 1)" style="text-decoration:none">
                        <table border="0" cellpadding="0" cellspacing="0">
                            <tr>
                                <td style="font-size:3em; vertical-align:middle; padding-right:10px">
                                    &#x1F880;
                                </td>
                                <td style="vertical-align:middle;">
                                    Pagina<br />precedentă
                                </td>
                            </tr>
                        </table>
                    </a>
                </td>
            }
            <td style="padding-right:10px; padding-left:10px; border-right: @((Model.IsLastPage && IsAnonymous) || !Model.Pagination.HasPages ? "none" : "solid 1px black")">
                @await Html.PartialAsync("_PaginationPartial", Model.Pagination, ViewData)
            </td>
            @if (!Model.IsLastPage)
            {
                <td style="padding-left:10px">
                    <a href="@Model.GetSearchLinkForPage(Model.PageNumber.Value + 1)" style="text-decoration:none">
                        <table border="0" cellpadding="0" cellspacing="0">
                            <tr>
                                <td style="vertical-align:middle;">
                                    Pagina<br />următoare
                                </td>
                                <td style="font-size:3em; vertical-align:middle; padding-left:10px">
                                    &#x1F882;
                                </td>
                            </tr>
                        </table>
                    </a>
                </td>
            }
        </tr>
    </table>

    foreach (var post in Model.Posts)
    {
        <div class="ForumListLeft" id="@post.PostId">
            <a asp-page="/ViewTopic" asp-page-handler="ByPostId" asp-route-postId="@post.PostId"><h4>@Html.Raw(post.PostSubject)</h4></a>
            <p>@Html.Raw(post.PostText)</p>
        </div>
        @await Html.PartialAsync(
            "_SummaryPartial",
            new _SummaryPartialModel
            {
                AuthorId = post.AuthorId,
                AuthorName = post.AuthorName,
                CreationTime = post.PostCreationTime,
                AssetId = post.PostId.Value,
                DateFormat = dateFormat,
                AuthorColor = post.AuthorColor
            }
        )
    }

    <table style="border:none;">
        <tr>
            @if (!Model.IsFirstPage)
            {
                <td style="padding-right:10px; border-right: solid 1px black">
                    <a href="@Model.GetSearchLinkForPage(Model.PageNumber.Value - 1)" style="text-decoration:none">
                        <table border="0" cellpadding="0" cellspacing="0">
                            <tr>
                                <td style="font-size:3em; vertical-align:middle; padding-right:10px">
                                    &#x1F880;
                                </td>
                                <td style="vertical-align:middle;">
                                    Pagina<br />precedentă
                                </td>
                            </tr>
                        </table>
                    </a>
                </td>
            }
            <td style="padding-right:10px; padding-left:10px; border-right: @((Model.IsLastPage && IsAnonymous) || !Model.Pagination.HasPages ? "none" : "solid 1px black")">
                @await Html.PartialAsync("_PaginationPartial", Model.Pagination, ViewData)
            </td>
            @if (!Model.IsLastPage)
            {
                <td style="padding-left:10px">
                    <a href="@Model.GetSearchLinkForPage(Model.PageNumber.Value + 1)" style="text-decoration:none">
                        <table border="0" cellpadding="0" cellspacing="0">
                            <tr>
                                <td style="vertical-align:middle;">
                                    Pagina<br />următoare
                                </td>
                                <td style="font-size:3em; vertical-align:middle; padding-left:10px">
                                    &#x1F882;
                                </td>
                            </tr>
                        </table>
                    </a>
                </td>
            }
        </tr>
    </table>
}

<link rel="stylesheet" href="~/lib/tribute/dist/tribute.css" />
<script src="~/lib/tribute/dist/tribute.js"></script>
<script>
    var tribute = new Tribute({
        values: @Json.Serialize(Model.Users) ,
        autocompleteMode:true
        });

    tribute.attach(document.getElementById("AuthorInput"));


</script>