@page
@model Serverless.Forum.Pages.ViewTopicModel
@{
    ViewData["Title"] = $"{Model.ForumTitle} - {Model.TopicTitle}";
    Layout = "~/Pages/_Layout.cshtml";
    var IsAnonymous = Model.CurrentUserId == 1;
    var IsLocked = Model.IsLocked &&
                   !(await Model.IsCurrentUserAdminHere(Model.ForumId.Value)) &&
                   !(await Model.IsCurrentUserModHere(Model.ForumId.Value));
    var UserDateFormat = (await Model.GetCurrentUserAsync())?.UserDateFormat ?? "dddd, dd.MM.yyyy, HH:mm";
}

<script type="text/javascript" src="~/js/site.js">
    window.onload = function () {
        onPostLoad();
        var postId = @Json.Serialize(Model.PostId ?? -1);
        var highlight = @Json.Serialize(Model.Highlight ?? true);
        if (postId != -1) {
            element = document.getElementById(postId);
            elementRect = element.getBoundingClientRect();
            absoluteElementTop = elementRect.top + window.pageYOffset;
            middle = absoluteElementTop - (window.innerHeight / 2);
            if (element.parentNode && highlight) {
                element.parentNode.style.borderWidth = "5px"
                element.parentNode.style.borderColor = "#33beff";
            }
            window.scrollTo(0, middle);
        }
    }

    function showSummary(summary, button) {
        if ($(summary).css("display") != "block") {
            var position = $(button).offset();
            $(summary).css("right", "30px");
            $(summary).css("top", position.top + $(button).height() + 10 + "px");
            $(summary).css("display", "block");
        }
        else {
            $(summary).css("display", "none");
        }
    }
</script>

@if (Model.ForumId != null)
{
    <h4>Forum părinte: <a asp-page="/ViewForum" asp-route-forumId="@Model.ForumId">@Model.ForumTitle</a></h4>
}
<h2>Subiect: @Model.TopicTitle</h2>

<table style="border:none">
    <tr>

        <td style="padding-right:10px; border-right: @(IsAnonymous || !Model.Pagination.HasPages ? "none" : "solid 1px black")">
            @await Html.PartialAsync("_PaginationPartial", Model.Pagination, ViewData)
        </td>

        @if (!IsAnonymous)
        {
            <td style="padding-left:10px;">
                <form method="post">
                    <label>Mesaje afișate pe pagină:&nbsp;</label>
                    <input type="hidden" name="topicId" value="@Model.TopicId" />
                    <input type="hidden" name="postId" value="@Model.Posts.FirstOrDefault()?.PostId" />
                    @Html.DropDownList("userPostsPerPage", Model.PostsPerPage)
                    &nbsp;
                    <input type="submit" value="Salvează" />
                </form>
            </td>
        }

    </tr>
</table>

@foreach (var post in Model.Posts)
{
    var divClass = post.Unread ? "ForumListRow Unread" : "ForumListRow";
    <div class="@divClass">
        <div class="ForumListLeft" id="@post.PostId">
            <span class="PostTitle">
                <a asp-page="/ViewTopic" asp-page-handler="ByPostId" asp-route-postId="@post.PostId">@Html.Raw(post.PostSubject)</a>
            </span>
            <span class="ForumListCollapsed" onclick="showSummary('#summary@(post.PostId.Value)', '#button@(post.PostId.Value)')" id="button@(post.PostId.Value)" style="color:@post.AuthorColor;font-weight:bold">
                @Html.Raw(post.AuthorName)
            </span>
            <p>&nbsp;</p>
            @Html.Raw(post.PostText)
            @foreach (var attachment in from a in post.Attachments
                                       where !a.IsDisplayedInline
                                       select a)
            {
                <br />
                <span style="padding:10px; margin:10px; border: solid 1px grey; border-radius: 5px; display:inline-block">
                    @await Html.PartialAsync("_AttachmentPartial", attachment, ViewData)
                </span>
            }
            <br />
            @if (!IsLocked)
            {
                <a asp-page="/Posting" asp-page-handler="QuoteForumPost" asp-route-postId="@post.PostId">Răspunde cu citat</a>
            }
            else
            {
                <a href="#" title="Subiectul este închis, nu se mai pot trimite răspunsuri."><s>Răspunde cu citat</s></a>
            }
        </div>
        @await Html.PartialAsync(
            "_SummaryPartial",
            new _SummaryPartialModel
            {
                AuthorId = post.AuthorId,
                AuthorName = post.AuthorName,
                CreationTime = post.PostCreationTime,
                AssetId = post.PostId.Value,
                DateFormat = UserDateFormat,
                AuthorColor = post.AuthorColor
            }
        )
    </div>
}
<p></p>
@if (!IsLocked)
{
    <a asp-page="/Posting" asp-page-handler="ForumPost" asp-route-topicId="@Model.TopicId">Scrie un răspuns</a>
}
else
{
    <a title="Subiectul este închis, nu se mai pot trimite răspunsuri."><s>Scrie un răspuns</s></a>
}
<p></p>

<table style="border:none;">
    <tr>
        @if (!Model.IsFirstPage)
        {
            <td style="padding-right:10px; border-right: solid 1px black">
                <a asp-page="/ViewTopic" asp-route-topicId="@Model.TopicId" asp-route-pageNum="@(Model.CurrentPage - 1)" style="text-decoration:none">
                    <table border="0" cellpadding="0" cellspacing="0">
                        <tr>
                            <td style="font-size:3em; vertical-align:middle; padding-right:10px">
                                &#x1F880;
                            </td>
                            <td style="vertical-align:middle;">
                                Pagina<br />precedentă
                            </td>
                        </tr>
                    </table>
                </a>
            </td>
        }
        <td style="padding-right:10px; padding-left:10px; border-right: @((Model.IsLastPage && IsAnonymous) || !Model.Pagination.HasPages ? "none" : "solid 1px black")">
            @await Html.PartialAsync("_PaginationPartial", Model.Pagination, ViewData)
        </td>
        @if (!IsAnonymous)
        {
            <td style="padding-right:10px; padding-left:10px; border-right: @(Model.IsLastPage ? "none" : "solid 1px black")">
                <form method="post">
                    <label>Mesaje afișate pe pagină:&nbsp;</label>
                    <input type="hidden" name="topicId" value="@Model.TopicId" />
                    <input type="hidden" name="postId" value="@Model.Posts.FirstOrDefault()?.PostId" />
                    @Html.DropDownList("userPostsPerPage", Model.PostsPerPage)
                    &nbsp;
                    <input type="submit" value="Salvează" />
                </form>
            </td>
        }
        @if (!Model.IsLastPage)
        {
            <td style="padding-left:10px">
                <a asp-page="/ViewTopic" asp-route-topicId="@Model.TopicId" asp-route-pageNum="@(Model.CurrentPage + 1)" style="text-decoration:none">
                    <table border="0" cellpadding="0" cellspacing="0">
                        <tr>
                            <td style="vertical-align:middle;">
                                Pagina<br />următoare
                            </td>
                            <td style="font-size:3em; vertical-align:middle; padding-left:10px">
                                &#x1F882;
                            </td>
                        </tr>
                    </table>
                </a>
            </td>
        }
    </tr>
</table>



