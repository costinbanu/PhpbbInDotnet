@page
@model Serverless.Forum.Pages.ViewTopicModel

@using System.Web
@using Serverless.Forum.Utilities

@inject Services.UserService _userService

@{
    ViewData["Title"] = $"{Model.ForumTitle} - {Model.TopicTitle}";
    Layout = "~/Pages/_Layout.cshtml";
    var IsAnonymous = Model.CurrentUserId == 1;
    var IsLocked = Model.IsLocked
                && !(await Model.IsCurrentUserAdminHereAsync(Model.ForumId.Value))
                && !(await Model.IsCurrentUserModeratorHereAsync(Model.ForumId.Value));
    var UserDateFormat = (await Model.GetCurrentUserAsync())?.UserDateFormat ?? "dddd, dd.MM.yyyy, HH:mm";
    var IsAdmin = await Model.IsCurrentUserAdminHereAsync();
    var IsMod = await Model.IsCurrentUserModeratorHereAsync();
    var EditTime = (await Model.GetCurrentUserAsync()).PostEditTime;
}

<script type="text/javascript">
    window.onload = function () {
        onPostLoad();
        var postId = @Json.Serialize(Model.PostId ?? -1);
        var highlight = @Json.Serialize(Model.Highlight ?? true);
        if (postId != -1) {
            var element = $("#" + postId);
            var elementTop = element.offset().top;
            var headerHeight = $("#topBanner").outerHeight(true);
            window.scrollTo(0, elementTop > headerHeight ? elementTop - headerHeight : elementTop);
            var container = element.parent().parent();
            if (container && highlight) {
                container.addClass("Highlight");
            }
        }
    }

    //forum tree callback
    function forumSelectCallback(forumId) {
        var forumInput = document.getElementById("ForumIdInput");
        if (forumInput != null) {
            forumInput.value = forumId;
        }
    }

    function switchPollPanels(id1, id2, button) {
        showElement(
            id1,
            function () {
                button.value = "Arată rezultatele";
            },
            function () {
                button.value = "Votează";
            }
        );
        showElement(id2);
    }

    //function showPostOptions(postId) {
    //    var actions = "actions" + postId;
    //    var buttonLeft = $("#actionsButton" + postId).position().left;
    //    showElement(
    //        actions,
    //        function () {
    //            $("#" + actions).animate({ "padding-left": "0px" }, "fast");
    //        },
    //        function () {
    //            $("#" + actions).animate({ "padding-left": buttonLeft + 10 + "px" }, "fast");
    //        }
    //    )
    //}
</script>

@if (Model.ForumId != null)
{
    <span>Forum părinte: <a asp-page="/ViewForum" asp-route-forumId="@Model.ForumId">@Model.ForumTitle</a></span>
}
<h2>Subiect: @Model.TopicTitle</h2>

@if (Model.Poll != null)
{
    if (Model.Poll.CanVoteNow(Model.CurrentUserId) || IsAnonymous)
    {
        <div id="votes" style="display:block">
            <h3>Chestionar: @Model.Poll.PollTitle</h3>
            <div>Chestionarul @(Model.Poll.PollEnded ? "a fost" : "va fi") inchis: @(Model.Poll.PollEnd.HasValue ? Model.Poll.PollEnd.Value.ToString(UserDateFormat) : "niciodată").</div>

            <form method="post" asp-page-handler="vote">
                @if (Model.Poll.PollMaxOptions > 1)
                {
                    foreach (var option in Model.Poll.PollOptions)
                    {
                        var isChecked = option.PollOptionVoters.Any(v => v.UserId == Model.CurrentUserId);
                        <table style="border:none; padding:unset; margin:unset; width:100%">
                            <tr style="border-bottom:solid 1px black">
                                <td style="width:50%; padding-right:10px; padding-top: 5px; padding-bottom: 5px">
                                    @Html.Raw(option.PollOptionText)
                                </td>
                                <td>
                                    <input type="checkbox" name="Votes" value="@option.PollOptionId" @(isChecked ? "checked" : "") @(IsAnonymous ? "disabled" : "") />
                                </td>
                            </tr>
                        </table>
                    }
                }
                else
                {
                    foreach (var option in Model.Poll.PollOptions)
                    {
                        var isChecked = option.PollOptionVoters.Any(v => v.UserId == Model.CurrentUserId);
                        <table style="border:none; padding:unset; margin:unset; width:100%">
                            <tr style="border-bottom:solid 1px black">
                                <td style="width:50%; padding-right:10px; padding-top: 5px; padding-bottom: 5px">
                                    @Html.Raw(option.PollOptionText)
                                </td>
                                <td>
                                    <input type="radio" name="Votes" value="@option.PollOptionId" @(isChecked ? "checked" : "") @(IsAnonymous ? "disabled" : "") />
                                </td>
                            </tr>
                        </table>
                    }
                }
                <br />
                <input asp-for="TopicId" type="hidden" />
                <input name="queryString" type="hidden" value="@HttpUtility.UrlEncode(Request.QueryString.ToString())" />
                <input type="submit" value="Trimite vot" @(IsAnonymous ? "disabled" : "") />
            </form>
        </div>
    }
    if ((!Model.Poll.CanVoteNow(Model.CurrentUserId) && !IsAnonymous) || IsAdmin)
    {
        <div id="results" style="display:@(Model.Poll.CanVoteNow(Model.CurrentUserId) && IsAdmin ? "none" : "block")">
            <h3>Chestionar: @Model.Poll.PollTitle</h3>
            <div>Chestionarul @(Model.Poll.PollEnded ? "a fost" : "va fi") inchis: @(Model.Poll.PollEnd.HasValue ? Model.Poll.PollEnd.Value.ToString(UserDateFormat) : "niciodată").</div>
            <p></p>
            <table style="border:none; padding:unset; margin:unset; width:100%">
                @foreach (var option in Model.Poll.PollOptions)
                {
                    <tr style="border-bottom:solid 1px black">
                        <td style="width:50%; padding-right:10px; padding-top: 5px; padding-bottom: 5px">
                            @Html.Raw(option.PollOptionText)
                            @if (await Model.IsCurrentUserAdminHereAsync(Model.ForumId ?? 0))
                            {
                                <div class="Caption">
                                    Votanti: @string.Join(", ", option.PollOptionVoters.Select(v => v.Username))
                                </div>
                            }
                        </td>
                        <td style="width:50%; padding-top: 5px; padding-bottom: 5px">
                            @{var percentage = (Model.Poll.TotalVotes == 0 ? 0 : option.PollOptionVotes * 100m / Model.Poll.TotalVotes).ToString("##0.##'%'", System.Globalization.CultureInfo.InvariantCulture);}
                            <span style="width: 100%; background: linear-gradient(to right, #87ceeb @percentage, #ffffff 0%); border: solid 1px black; display: inline-block; padding:2px">
                                @option.PollOptionVotes @(option.PollOptionVotes == 1 ? "vot" : "voturi") (@(percentage))
                            </span>
                        </td>
                    </tr>
                }
            </table>
        </div>
        @if (Model.Poll.CanVoteNow(Model.CurrentUserId) && IsAdmin)
        {
            <br />
            <input type="button" value="Arată rezultatele" onclick="switchPollPanels('results', 'votes', this)" />
        }
    }
    <hr />
}

@await Html.PartialAsync(
    "_PaginationControlsPartial",
    new CustomPartials._PaginationControlsPartialModel(
        pagination: Model,
        allowPaginationChange: true,
        back: $"ViewTopic?TopicId={Model.TopicId}&PageNum={Model.Pagination.CurrentPage - 1}",
        forward: $"ViewTopic?TopicId={Model.TopicId}&PageNum={Model.Pagination.CurrentPage + 1}",
        includeEasyNavigation: false,
        topicId: Model.TopicId,
        lastPostId: Model.Posts.LastOrDefault()?.PostId
    ),
    ViewData
)
<hr />
@{ var index = 0; }
@foreach (var post in Model.Posts)
{
    <div class="RowMargin @(post.Unread ? "Unread" : $"Color{index % 2}")">
        <div class="ForumListRow">
            @await Html.PartialAsync(
                "_SummaryPartial",
                new CustomPartials._SummaryPartialModel(post.AuthorId, post.AuthorName, post.AuthorColor, post.PostCreationTime, post.PostId.Value,
                    UserDateFormat, post.AuthorHasAvatar, null, null, null, true)
            )
            <div class="ForumContent VerticalContent FlexRight" id="@post.PostId">
                <span style="display:flex">
                    <span class="PostTitle">
                        <a asp-page="/ViewTopic" asp-page-handler="ByPostId" asp-route-postId="@post.PostId">@Html.Raw(post.PostSubject)</a>
                    </span>
                    <span style="margin-left:auto">
                        <span class="CollapsedMenu" onclick="expandCollapsedMenu('summary@(post.PostId.Value)', 'button@(post.PostId.Value)')" id="button@(post.PostId.Value)" style="color:#@post.AuthorColor;margin-left: auto; height:auto">
                            @Html.Raw(post.AuthorName)
                        </span>
                    </span>
                </span>
                <div>
                    <br />
                    @Html.Raw(post.PostText)
                    @foreach (var attachment in post.Attachments)
                    {
                        <br />
                        @await Html.PartialAsync("_AttachmentPartial", attachment, ViewData)
                    }
                    <br />
                </div>
                <div class="PostFooter">
                    @if (post.LastEditTime > 0)
                    {
                        <br />
                        <div class="Caption" style="color:#495d6c">
                            Ultima dată modificat de @post.LastEditUser pe @post.LastEditTime.ToUtcTime().ToString(UserDateFormat). Motiv: @post.LastEditReason. Modificări în total: @post.EditCount.
                        </div>
                    }
                    @if (!string.IsNullOrWhiteSpace(post.AuthorSignature))
                    {
                        <div style="width:25%; display:inline-block; border-bottom:solid 1px black">&nbsp;</div>
                        <br />
                        @Html.Raw(post.AuthorSignature)
                        <br />
                    }
                    <br />
                    <div class="PostActions">
                        @if (!IsLocked && !IsAnonymous && post != Model.Posts.Last())
                        {
                            <a asp-page="/Posting" asp-page-handler="QuoteForumPost" asp-route-forumId="@Model.ForumId" asp-route-topicId="@Model.TopicId" asp-route-postId="@post.PostId">
                                &#x1F5E8; Răspunde cu citat
                            </a>
                            @*<span style="padding-left:10px;padding-right:3px;">&bull;</span>*@
                        }
                        else if (!IsAnonymous && post != Model.Posts.Last())
                        {
                            <a href="javascript:;" title="Subiectul este închis, nu se mai pot trimite răspunsuri.">
                                <s>&#x1F5E8; Răspunde cu citat</s>
                            </a>
                            @*<span style="padding-left:10px;padding-right:3px;">&bull;</span>*@
                        }
                        @*<span class="CollapsedActions" onclick="showElement('actions@(post.PostId.Value)')" id="actionsButton@(post.PostId.Value)">
                                &#x1F4CB; Opțiuni mesaj
                            </span>*@
                        @*<ul class="PostActions" id="actions@(post.PostId.Value)">*@
                        @if (await _userService.GetUserRole(await Model.GetCurrentUserAsync()) != 8)
                        {
                            <span>
                                <a asp-page="/Posting" asp-page-handler="QuotePrivateMessage" asp-route-postId="@post.PostId">&#x2709; Mesaj privat</a>
                            </span>
                        }
                        <span>
                            <a href="javascript:return;">&#x2757; Raportează</a>
                        </span>
                        @if (IsMod)
                        {
                            <span>
                                <a href="javascript:return;">&#x2753; Informații</a>
                            </span>
                            <span>
                                Selectează pentru moderare <input type="checkBox" name="posts" value="@post.PostId" form="moderatorForm" />
                            </span>
                        }
                        @if (IsMod || (post.AuthorId == Model.CurrentUserId && DateTime.UtcNow.Subtract(post.PostCreationTime ?? default).TotalMinutes <= EditTime))
                        {
                            <span>
                                <a asp-page="/Posting" asp-page-handler="EditPost" asp-route-forumId="@Model.ForumId" asp-route-topicId="@Model.TopicId" asp-route-postId="@post.PostId">&#x1F4DD; Modifică</a>
                            </span>
                        }
                        @*</ul>*@
                    </div>
                </div>
            </div>
            <p>&nbsp;</p>
        </div>
    </div>
    index++;
}
<hr />
@if (!IsLocked && !IsAnonymous)
{
    <a asp-page="/Posting" asp-page-handler="ForumPost" asp-route-forumId="@Model.ForumId" asp-route-topicId="@Model.TopicId">Scrie un răspuns</a>
    <hr />
}
else if (!IsAnonymous)
{
    <a title="Subiectul este închis, nu se mai pot trimite răspunsuri."><s>Scrie un răspuns</s></a>
    <hr />
}
@await Html.PartialAsync(
    "_PaginationControlsPartial",
    new CustomPartials._PaginationControlsPartialModel(
        pagination: Model,
        allowPaginationChange: true,
        back: $"ViewTopic?TopicId={Model.TopicId}&PageNum={Model.Pagination.CurrentPage - 1}",
        forward: $"ViewTopic?TopicId={Model.TopicId}&PageNum={Model.Pagination.CurrentPage + 1}",
        includeEasyNavigation: true,
        topicId: Model.TopicId,
        lastPostId: Model.Posts.LastOrDefault()?.PostId
    ),
    ViewData
)
<hr />
<span onclick="showElement('forumTree')" style="cursor:pointer; font-weight:bold">Navigare - alege destinația &#x2935;</span>
<p>&nbsp;</p>
<div id="forumTree" style=" display:none">
    <div style="height:400px; max-height:600px; overflow-y:scroll;">
        @await Html.PartialAsync(
            "_ForumTreePartial",
             new CustomPartials._ForumTreePartialModel
             {
                 Forums = await Model.GetForumTreeAsync(),
                 ForumId = Model.ForumId,
                 TopicId = Model.TopicId,
                 PathToForumOrTopic = await Model.PathToForumOrTopic(Model.ForumId.Value, Model.TopicId)
             },
            ViewData
        )
    </div>
    <p></p>
    <form action="/ViewForum">
        <input type="hidden" name="ForumId" id="ForumIdInput" />
        <input type="submit" value="Du-te" />
    </form>
</div>
<hr />
@if (IsMod)
{
    <form id="moderatorForm" method="post" asp-page-handler="Moderator">
        <span>Acțiuni moderare (cu mesajele selectate): </span>
        @Html.DropDownList("action", Enum.GetValues(typeof(ModeratorActions)).Cast<int>().Select(x => new SelectListItem(Enum.GetName(typeof(ModeratorActions), x), x.ToString())))
        <input type="submit" value="Trimite" />
        <br />
        <span asp-validation-for="ModeratorActionResult" class="validation"></span>
        @if (!string.IsNullOrWhiteSpace(Model.ModeratorActionResult))
        {
            <br />
            <span style="margin-left: 30px; color: green; display:block;">@Model.ModeratorActionResult</span>
        }
        <input asp-for="TopicId" type="hidden" />
        <input asp-for="PageNum" type="hidden" />
    </form>
}