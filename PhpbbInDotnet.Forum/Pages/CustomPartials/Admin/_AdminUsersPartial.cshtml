@model PhpbbInDotnet.Forum.Pages.CustomPartials.Admin._AdminUsersPartialModel
@using Microsoft.EntityFrameworkCore
@using Utilities

@inject Services.AdminUserService _adminUserService
@inject Database.ForumDbContext _context

<h4 onclick="expandSection('inactiveUsersSection', 'inactiveUsersChar')" style="cursor:pointer" id="inactiveUsersTitle">
    Utilizatori inactivi
    <span id="inactiveUsersChar">&#x1F53D;</span>
</h4>
<div id="inactiveUsersSection" style="display:none">
    <form method="post" id="userManagement" name="userManagement" asp-page-handler="UserManagement">
        <input type="hidden" name="userAction" id="userAction" />
        <input type="hidden" name="userId" id="userId" />
    </form>

    @{
        var inactive = await _adminUserService.GetInactiveUsers();

        @await Html.PartialAsync(
            "_AdminUsersSummaryPartial",
            new _AdminUsersSummaryPartialModel
            {
                DateFormat = Model.DateFormat,
                Users = inactive
            },
            ViewData
        );

        if (inactive.Any(u => u.UserInactiveReason == UserInactiveReason.NewlyRegisteredNotConfirmed))
        {
            <p></p>
            <script>
                function selectAllUsers() {
                    var checkboxes = $('input[name=userIds]');
                    checkboxes.prop('checked', !checkboxes.prop('checked'));
                }
            </script>
            <form method="post" id="batchAdminUsers" name="batchAdminUsers" asp-page-handler="BatchUserManagement">
                <button type="button" onclick="selectAllUsers()" class="MyButton SpacedButton">Selectează toți utilizatorii inactivi</button>
                <input type="submit" value="Șterge utilizatorii inactivi selectați" onclick="return confirm('Utilizatorii inactivi selectați vor fi șterși. Continui?');" class="MyButton SpacedButton" />
            </form>
        }
    }
    <div style="width:100%; text-align:right; font-size:1.5em">
        <a href="#inactiveUsersTitle">&#x23EB;</a>
    </div>
</div>
<hr class="BoxSeparator" />
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<style>
    .DummyDatePicker {
    }
</style>
<script>
    var $ = jQuery.noConflict();
    $(function () {
        $(".DummyDatePicker").each((_, elem) => {
            $(elem).datepicker({
                dateFormat: 'dd.mm.yy',
                firstDay: 1,
                dayNamesMin: $.map(dayNames, day => day.substring(0, 2)),
                dayNamesShort: $.map(dayNames, day => day.substring(0, 3)),
                dayNames: dayNames,
                monthNames: monthNames,
                monthNamesShort: $.map(monthNames, month => month.substring(0, 3)),
                changeMonth: true,
                changeYear: true
            });
        });
        clearActiveDates(document.getElementById('neverActiveCheckbox'));
    });

    function clearActiveDates(inactive) {
        if (inactive.checked) {
            $('#lastActiveFrom').val('');
            $('#lastActiveTo').val('')
            $('#lastActiveFrom').prop('disabled', true);
            $('#lastActiveTo').prop('disabled', true);
        } else {
            $('#lastActiveFrom').prop('disabled', false);
            $('#lastActiveTo').prop('disabled', false);
        }
    }
</script>
<h4 onclick="expandSection('searchUsersSection', 'searchUsersChar')" style="cursor:pointer" id="searchUsersTitle">
    Caută utilizatori
    @if (Model.SearchParameters != null || Model.SearchResults.Any())
    {
        <span id="searchUsersChar">&#x1F53C;</span>
    }
    else
    {
        <span id="searchUsersChar">&#x1F53D;</span>
    }
</h4>
<div id="searchUsersSection" style="@(Model.SearchParameters != null || Model.SearchResults.Any() ? "display:block" : "display:none")">
    <form method="post" id="userSearch" asp-page-handler="UserSearch">
        <div class="FlexCenter">
            <div class="FlexCaption">
                Nume utilizator
            </div>
            <div class="FlexRight PostInputWidth">
                <input type="text" asp-for="SearchParameters.Username" />
            </div>
        </div>
        <div class="FlexCenter FlexSpaced">
            <div class="FlexCaption">
                E-mail
            </div>
            <div class="FlexRight PostInputWidth">
                <input type="text" asp-for="SearchParameters.Email" />
            </div>
        </div>
        <div class="FlexCenter FlexSpaced">
            <div class="FlexCaption">
                Id
            </div>
            <div class="FlexRight PostInputWidth">
                <input type="text" asp-for="SearchParameters.UserId" />
            </div>
        </div>
        <div class="FlexCenter FlexSpaced">
            <div class="FlexCaption">
                Înregistrat între
            </div>
            <div class="FlexRight PostInputWidth">
                De la<br />
                <input type="text" asp-for="SearchParameters.RegisteredFrom" class="DummyDatePicker" /><br />
                Până la<br />
                <input type="text" asp-for="SearchParameters.RegisteredTo" class="DummyDatePicker" /><br />
            </div>
        </div>
        <div class="FlexCenter FlexSpaced">
            <div class="FlexCaption">
                Ultima dată activ între
            </div>
            <div class="FlexRight PostInputWidth">
                De la<br />
                <input type="text" asp-for="SearchParameters.LastActiveFrom" class="DummyDatePicker" id="lastActiveFrom" /><br />
                Până la<br />
                <input type="text" asp-for="SearchParameters.LastActiveTo" class="DummyDatePicker" id="lastActiveTo" /><br />
                <label>
                    @Html.CheckBoxFor(m => m.SearchParameters.NeverActive, new { onchange = "clearActiveDates(this)", id = "neverActiveCheckbox" })
                    Niciodată (nici o autentificare realizată)
                </label>
            </div>
        </div>
        <input type="submit" value="Caută" class="MyButton SpacedButton" />
    </form>

    @if (Model.SearchResults.Any())
    {
        @await Html.PartialAsync(
            "_AdminUsersSummaryPartial",
            new _AdminUsersSummaryPartialModel
            {
                DateFormat = Model.DateFormat,
                Users = Model.SearchResults
            },
            ViewData
        );
    }
    <div style="width:100%; text-align:right; font-size:1.5em">
        <a href="#searchUsersTitle">&#x23EB;</a>
    </div>
</div>
<hr class="BoxSeparator" />
<h4 onclick="expandSection('groupsSection', 'groupsChar')" style="cursor:pointer" id="groupsTitle">
    Grupuri
    <span id="groupsChar">&#x1F53D;</span>
</h4>
<div id="groupsSection" style="display:none">
    @{
        var groups = await (
            from g in _context.PhpbbGroups.AsNoTracking()
            let role = _context.PhpbbAclGroups.AsNoTracking().FirstOrDefault(rg => rg.GroupId == g.GroupId && rg.ForumId == 0)
            select new PhpbbInDotnet.Objects.UpsertGroupDto
            {
                Id = g.GroupId,
                Name = g.GroupName,
                Desc = g.GroupDesc,
                Rank = g.GroupRank,
                Color = $"#{g.GroupColour}",
                EditTime = g.GroupEditTime,
                UploadLimit = g.GroupUserUploadSize,
                Role = role == null ? 0 : role.AuthRoleId
            }
        ).ToListAsync();
        var groupRanks = new List<SelectListItem> { new SelectListItem("Nici unul", "0", true) };
        groupRanks.AddRange(_context.PhpbbRanks.AsNoTracking().Select(x => new SelectListItem(x.RankTitle, x.RankId.ToString())));
        var roles = new List<SelectListItem> { new SelectListItem("Nici una", "0", true) };
        roles.AddRange(_context.PhpbbAclRoles.AsNoTracking().Where(x => x.RoleType == "u_").Select(x => new SelectListItem(x.RoleName, x.RoleId.ToString())));

        foreach (var group in groups)
        {
            <a href='javascript:populateGroup(@Json.Serialize(group))'>@Html.Raw(group.Name)</a>
            <br />
        }
    }
    <p>&nbsp;</p>
    <a href="javascript:newGroup()">Adaugă un grup nou</a>
    <div style="width:100%; text-align:right; font-size:1.5em">
        <a href="#groupsTitle">&#x23EB;</a>
    </div>
</div>
<hr class="BoxSeparator" />
<h4 onclick="expandSection('ranksSection', 'ranksChar')" style="cursor:pointer" id="ranksTitle">
    Ranguri
    <span id="ranksChar">&#x1F53D;</span>
</h4>
<div id="ranksSection" style="display:none">
    @foreach (var rank in await _context.PhpbbRanks.AsNoTracking().ToListAsync())
    {
        <a href="javascript:populateRank(@rank.RankId, '@rank.RankTitle')">@rank.RankTitle</a>
        <br />
    }
    <p>&nbsp;</p>
    <a href="javascript:newRank()">Adaugă un rang nou</a>
    <div style="width:100%; text-align:right; font-size:1.5em">
        <a href="#ranksTitle">&#x23EB;</a>
    </div>
</div>
<hr class="BoxSeparator" />
<h4 onclick="expandSection('bansSection', 'bansChar')" style="cursor:pointer" id="bansTitle">
    Interziceri
    <span id="bansChar">&#x1F53D;</span>
</h4>
<div id="bansSection" style="display:none">
    @{
        var banlist = await _context.PhpbbBanlist.AsNoTracking().ToListAsync();
        <form method="post" asp-page-handler="BanUser">
            @for (var i = 0; i < banlist.Count; i++)
            {
                <div class="FlexCenter">
                    <div class="FlexCaption">
                        IP
                    </div>
                    <div class="FlexRight PostInputWidth">
                        <input type="hidden" name="banlist[@i].BanId" value="@banlist[i].BanId" />
                        <input type="text" name="banlist[@i].BanIp" value="@banlist[i].BanIp" />
                    </div>
                </div>
                <div class="FlexCenter FlexSpaced">
                    <div class="FlexCaption">
                        E-mail
                    </div>
                    <div class="FlexRight PostInputWidth">
                        <input type="text" name="banlist[@i].BanEmail" value="@banlist[i].BanEmail" />
                    </div>
                </div>
                <div class="FlexCenter FlexSpaced">
                    <div class="FlexCaption">
                        Șterge?
                    </div>
                    <div class="FlexRight PostInputWidth">
                        <label><input type="checkbox" name="toRemove" value="@banlist[i].BanId" /> Da, șterge</label>
                    </div>
                </div>
                @if (i < banlist.Count - 1)
                {
                    <hr class="SubtypeSeparator" />
                }
            }
            <div id="newBans"></div>
            <input type="button" onclick="addBannedItem()" value="Adaugă o interzicere nouă" class="MyButton SpacedButton" />
            <input type="submit" value="Salvează modificările" class="MyButton SpacedButton" />
        </form>
        <script type="text/javascript">
        var cur = @banlist.Count;

        function addBannedItem(email = '', ip = '') {
            var elem = $(
                "<div>" +
                "<hr class='SubtypeSeparator' />" +
                "<input type='hidden' name='banlist[" + cur + "].BanId' value='0'/>" +
                "<b>IP:</b><br /><input type='text' name='banlist[" + cur + "].BanIp' value='" + ip + "' />" +
                "<p style='clear:both'></p>" +
                "<b>E-mail:</b><br /><input type='text' name='banlist[" + cur + "].BanEmail' value='" + email + "' />" +
                "<p style='clear:both'></p>" +
                "<a href=\"#!\" onclick=\"cancelAddBannedWord(this)\">Anulează</a>" +
                "</div>"
            );

            elem.appendTo($("#newBans"));
            cur++;

            if ((email || ip) && elem.offset()) {
                $("html,body").animate({ "scrollTop": elem.offset().top }, 300, function () {
                    elem.fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100);
                });
            }
        }

        function cancelAddBannedItem(elem) {
            $(elem).parent().parent().remove();
            cur--;
        }
        </script>
    }
    <div style="width:100%; text-align:right; font-size:1.5em">
        <a href="#bansTitle">&#x23EB;</a>
    </div>
</div>
<script type="text/javascript">
    function submitUserForm(userId, userName, action) {
        msg = "Am primit comanda '" + action + "' pentru utilizatorul '" + userName + "'. Sunteți sigur că doriți să continuați cu execuția acestei comenzi?";

        if (confirm(msg)) {
            document.getElementById("userAction").value = action;
            document.getElementById("userId").value = userId;
            document.getElementById("userManagement").submit();
        }
    }

    function populateGroup(group) {
        $('#groupId').val(group.id);
        $('#groupName').val(group.name);
        $('#groupNameTitle').text('Administrează grup - ' + group.name);
        $('#groupDesc').val(group.desc);
        $('#rank').val(group.rank);
        $('#role').val(group.role);
        $('#color').val(group.color);
        $('#colorTitle').text($('#color').val());
        $('#uploadLimit').val(group.uploadLimit / 1024 / 1024);
        $('#editTime').val(group.editTime);
        $('#deleteGroup').prop('disabled', false);
        $('#deleteGroup').prop('checked', false);
        showElement('groupAdministration');
    }

    function newGroup() {
        $('#groupId').val(0);
        $('#groupName').val('');
        $('#groupName').css('background-color', 'white');
        $('#groupNameTitle').text('Adaugă un grup nou');
        $('#groupDesc').val('');
        $('#rank').val('0');
        $('#role').val('0');
        $('#color').val('#000000');
        $('#colorTitle').text('#000000');
        $('#uploadLimit').val(250);
        $('#uploadLimit').css('background-color', 'white');
        $('#editTime').val(60);
        $('#editTime').css('background-color', 'white');
        $('#deleteGroup').prop('checked', false);
        $('#deleteGroup').prop('disabled', true);
        showElement('groupAdministration');
    }

    function populateRank(id, name) {
        $('#rankName').val(name);
        $('#rankId').val(id);
        $('#deleteRank').prop('checked', false);
        $('#deleteRank').prop('disabled', false);
        showElement('rankAdministration');
    }

    function newRank(name) {
        $('#rankName').val(name);
        $('#rankId').val(0);
        $('#deleteRank').prop('checked', false);
        $('#deleteRank').prop('disabled', true);
        showElement('rankAdministration')
    }

    function validateGroup() {
        var name = $('#groupName'), uploadLimit = $('#uploadLimit'), editTime = $('#editTime');
        var toReturn = true;

        if (!name.val()) {
            name.css('background-color', '#ffc2df');
            toReturn = false;
        }
        if (!uploadLimit.val()) {
            $('#uploadLimit').css('background-color', '#ffc2df');
            toReturn = false;
        }
        if (!editTime.val()) {
            $('#editTime').css('background-color', '#ffc2df');
            toReturn = false;
        }

        return toReturn;
    }

</script>

<form method="post" asp-page-handler="GroupManagement" id="groupAdministration" class="MiddleBox" style="display:none; padding: 10px; overflow-y: scroll">
    <h4 style="float:left" id="groupNameTitle"></h4>
    <div style="float:right; cursor:pointer; font-weight:bold" onclick="showElement('groupAdministration')">Închide [X]</div>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <div class="FlexCenter">
        <div style="font-weight:bold; text-align: right">
            Nume grup
        </div>
        <div class="FlexRight PostInputWidth">
            <input type="text" name="dto.name" autocomplete="new-password" id="groupName" />
        </div>
    </div>
    <p></p>
    <div class="FlexCenter">
        <div style="font-weight:bold; text-align: right">
            Descriere grup
        </div>
        <div class="FlexRight PostInputWidth">
            <textarea rows="4" cols="100" name="dto.desc" autocomplete="new-password" id="groupDesc"></textarea>
        </div>
    </div>
    <p></p>
    <div class="FlexCenter">
        <div style="font-weight:bold; text-align: right">
            Rang
        </div>
        <div class="FlexRight PostInputWidth">
            @Html.DropDownList("dto.rank", groupRanks, new { id = "rank" })
        </div>
    </div>
    <p></p>
    <div class="FlexCenter">
        <div style="font-weight:bold; text-align: right">
            Culoare
        </div>
        <div class="FlexRight PostInputWidth">
            <input type="color" name="dto.color" class="jscolor" autocomplete="new-password" id="color" onchange="$('#colorTitle').text($(this).val())" />
            &nbsp;<span id="colorTitle" style="font-weight:bold; font-family:'Ubuntu Mono'; font-size: 1.5em"></span>
        </div>
    </div>
    <p></p>
    <div class="FlexCenter">
        <div style="font-weight:bold; text-align: right">
            Limită upload (MB)
        </div>
        <div class="FlexRight PostInputWidth">
            <input type="text" name="dto.uploadLimit" autocomplete="new-password" id="uploadLimit" /><br />
            <span class="Caption">"0" = nelimitat</span>
        </div>
    </div>
    <p></p>
    <div class="FlexCenter">
        <div style="font-weight:bold; text-align: right">
            Timp editare mesaje (min.)
        </div>
        <div class="FlexRight PostInputWidth">
            <input type="text" name="dto.editTime" autocomplete="new-password" id="editTime" /><br />
            <span class="Caption">"0" = nelimitat</span>
        </div>
    </div>
    <p></p>
    <div class="FlexCenter">
        <div style="font-weight:bold; text-align: right">
            Permisiuni
        </div>
        <div class="FlexRight PostInputWidth">
            @Html.DropDownList("dto.role", roles, new { id = "role" })
        </div>
    </div>
    <p></p>
    <div class="FlexCenter">
        <div style="font-weight:bold; text-align: right">
            <label>
                @Html.CheckBox("dto.delete", false, new { id = "deleteGroup" })
                Șterge acest grup
            </label>
        </div>
    </div>
    <p></p>
    <input type="submit" value="Salvează modificările" onclick="return validateGroup();" class="MyButton" />
    <input type="hidden" name="dto.id" id="groupId" />
</form>

<form method="post" asp-page-handler="RankManagement" id="rankAdministration" class="MiddleBox" style="display:none; padding: 10px; overflow-y: scroll">
    <h4 style="float:left" id="groupNameTitle"></h4>
    <div style="float:right; cursor:pointer; font-weight:bold" onclick="showElement('rankAdministration')">Închide [X]</div>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <div class="FlexCenter">
        <div style="font-weight:bold; text-align: right">
            Nume rang
        </div>
        <div class="FlexRight PostInputWidth">
            <input type="text" name="rankName" autocomplete="new-password" id="rankName" />
        </div>
    </div>
    <p></p>
    <div class="FlexCenter">
        <div style="font-weight:bold; text-align: right">
            <label>
                @Html.CheckBox("deleteRank", false, new { id = "deleteRank" })
                Șterge acest rang
            </label>
        </div>
    </div>
    <input type="hidden" name="rankId" id="rankId" />
    <input type="submit" value="Salvează modificările" onclick="return $('#rankName').val() ? true : false;" class="MyButton" />
</form>